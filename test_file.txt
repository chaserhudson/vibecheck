This is a legacy system with a lot of workarounds. # TODO: fix this hack